<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Keuangan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #FF9800;
            --success-color: #4CAF50;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --border-color: #333333;
            --shadow: 0 2px 10px rgba(255,255,255,0.1);
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            max-width: 390px;
            margin: 0 auto;
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        .container {
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login Page */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
        }
        
        .login-card {
            background: var(--card-bg);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 350px;
            text-align: center;
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.6s ease forwards;
        }
        
        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 16px;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-btn {
            background: #4285f4;
            color: white;
        }
        
        .google-btn:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        
        .guest-btn {
            background: #f0f0f0;
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }
        
        .guest-btn:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }
        
        /* Header */
        .header {
            background: var(--card-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: var(--border-color);
            transform: rotate(90deg);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .tab-container {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .tab-content {
            width: 33.333%;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Dashboard */
        .balance-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .balance-label {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .income-expense-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .income-expense-card {
            flex: 1;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .income-card {
            border-left: 4px solid var(--success-color);
        }
        
        .expense-card {
            border-left: 4px solid var(--danger-color);
        }
        
        .card-label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 8px;
        }
        
        .card-amount {
            font-size: 20px;
            font-weight: bold;
        }
        
        .income-amount {
            color: var(--success-color);
        }
        
        .expense-amount {
            color: var(--danger-color);
        }
        
        /* Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chart-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .chart-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .chart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        /* Transaction Buttons */
        .transaction-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60vh;
            gap: 20px;
        }
        
        .transaction-btn {
            width: 120px;
            height: 120px;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }
        
        .income-btn {
            background: var(--success-color);
            color: white;
        }
        
        .expense-btn {
            background: var(--danger-color);
            color: white;
        }
        
        .transaction-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .transaction-btn i {
            font-size: 30px;
        }
        
        /* Transaction Form */
        .transaction-form {
            display: none;
            padding: 20px;
        }
        
        .form-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: var(--border-color);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: var(--danger-color);
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .category-tag {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .category-tag:hover {
            transform: translateY(-2px);
        }
        
        .category-tag.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .save-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        /* History */
        .history-filters {
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .filter-select {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .transaction-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .transaction-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .transaction-item:hover {
            transform: translateX(5px);
        }
        
        .transaction-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .transaction-details h4 {
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .transaction-details p {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .transaction-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            background: var(--warning-color);
            color: white;
        }
        
        .delete-btn {
            background: var(--danger-color);
            color: white;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            background: var(--card-bg);
            padding: 15px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            position: sticky;
            bottom: 0;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 10px;
        }
        
        .nav-item:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .nav-item.active i {
            transform: scale(1.2);
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 1000;
            padding-top: 60px;
        }
        
        .settings-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 350px;
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .settings-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .settings-item:hover {
            background: var(--border-color);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        /* Wallet Modal */
        .wallet-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .wallet-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 350px;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: var(--shadow);
        }
        
        .wallet-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .wallet-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .wallet-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 390px) {
            .container {
                padding: 0 10px;
            }
            
            .balance-amount {
                font-size: 28px;
            }
            
            .transaction-btn {
                width: 100px;
                height: 100px;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .loading {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-title">
                <i class="fas fa-wallet"></i> Keuangan
            </div>
            <p class="login-subtitle">Kelola keuangan Anda dengan mudah</p>
            
            <button class="login-btn google-btn" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i>
                Masuk dengan Google
            </button>
            
            <button class="login-btn guest-btn" onclick="loginAsGuest()">
                <i class="fas fa-user"></i>
                Masuk sebagai Tamu
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title" id="headerTitle">Keuangan</h1>
            <button class="settings-btn" onclick="openSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="tab-container" id="tabContainer">
                <!-- Dashboard Tab -->
                <div class="tab-content" id="dashboardTab">
                    <div class="balance-card">
                        <div class="balance-label">Saldo Total</div>
                        <div class="balance-amount" id="totalBalance">Rp 0</div>
                    </div>
                    
                    <div class="income-expense-row">
                        <div class="income-expense-card income-card">
                            <div class="card-label">Pemasukan</div>
                            <div class="card-amount income-amount" id="totalIncome">Rp 100.000.000</div>
                        </div>
                        <div class="income-expense-card expense-card">
                            <div class="card-label">Pengeluaran</div>
                            <div class="card-amount expense-amount" id="totalExpense">Rp 100.000.000</div>
                        </div>
                    </div>
                    
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="changeChartPeriod('week')">Minggu</button>
                        <button class="chart-btn" onclick="changeChartPeriod('month')">Bulan</button>
                        <button class="chart-btn" onclick="changeChartPeriod('year')">Tahun</button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="financeChart" width="300" height="200"></canvas>
                    </div>
                    
                    <div class="income-expense-row">
                        <div class="income-expense-card income-card">
                            <div class="card-label">Pemasukan Hari Ini</div>
                            <div class="card-amount income-amount" id="todayIncome">Rp 9.000.000</div>
                        </div>
                        <div class="income-expense-card expense-card">
                            <div class="card-label">Pengeluaran Hari Ini</div>
                            <div class="card-amount expense-amount" id="todayExpense">Rp 9.000.000</div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Tab -->
                <div class="tab-content" id="transactionTab">
                    <div class="transaction-buttons" id="transactionButtons">
                        <button class="transaction-btn income-btn" onclick="showTransactionForm('income')">
                            <i class="fas fa-plus"></i>
                            Pemasukan
                        </button>
                        <button class="transaction-btn expense-btn" onclick="showTransactionForm('expense')">
                            <i class="fas fa-minus"></i>
                            Pengeluaran
                        </button>
                    </div>
                    
                    <div class="transaction-form" id="transactionForm">
                        <div class="form-title">
                            <button class="back-btn" onclick="hideTransactionForm()">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <span id="formTitle">Pemasukan</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jumlah (Rp)</label>
                            <input type="text" class="form-input" id="amountInput" placeholder="0" oninput="formatCurrency(this)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-input" id="dateInput">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kategori</label>
                            <div class="category-tags" id="categoryTags">
                                <!-- Categories will be populated by JavaScript -->
                            </div>
                            <input type="text" class="form-input hidden" id="customCategoryInput" placeholder="Masukkan kategori custom">
                        </div>
                        
                        <button class="save-btn" onclick="saveTransaction()">
                            <i class="fas fa-save"></i> Simpan Transaksi
                        </button>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-content" id="historyTab">
                    <div class="history-filters">
                        <div class="filter-row">
                            <select class="filter-select" id="filterSelect" onchange="filterTransactions()">
                                <option value="all">Semua</option>
                                <option value="date">Tanggal</option>
                                <option value="month">Bulan</option>
                                <option value="year">Tahun</option>
                            </select>
                            <input type="date" class="filter-select" id="dateFilter" onchange="filterTransactions()">
                        </div>
                        <input type="text" class="search-input" id="searchInput" placeholder="Cari berdasarkan kategori..." oninput="searchTransactions()">
                    </div>
                    
                    <div class="transaction-list" id="transactionList">
                        <!-- Transaction items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab(0)">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchTab(1)">
                <i class="fas fa-plus-circle"></i>
                <span>Transaksi</span>
            </div>
            <div class="nav-item" onclick="switchTab(2)">
                <i class="fas fa-history"></i>
                <span>History</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-item" onclick="showAccountInfo()">
                <i class="fas fa-user"></i>
                <span>Akun</span>
            </div>
            <div class="settings-item">
                <i class="fas fa-moon"></i>
                <span>Mode Gelap</span>
                <div class="theme-toggle">
                    <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
            <div class="settings-item" onclick="showAbout()">
                <i class="fas fa-info-circle"></i>
                <span>Tentang</span>
            </div>
            <div class="settings-item" onclick="showWalletManager()">
                <i class="fas fa-wallet"></i>
                <span>Kelola Dompet</span>
            </div>
            <div class="settings-item" onclick="logout()" style="color: var(--danger-color);">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </div>
        </div>
    </div>

    <!-- Wallet Manager Modal -->
    <div class="wallet-modal" id="walletModal">
        <div class="wallet-content">
            <h3>Kelola Dompet</h3>
            <div class="form-group">
                <input type="text" class="form-input" id="newWalletInput" placeholder="Nama dompet baru">
                <button class="save-btn" onclick="addWallet()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Tambah Dompet
                </button>
            </div>
            <div class="wallet-list" id="walletList">
                <!-- Wallet items will be populated by JavaScript -->
            </div>
            <button class="save-btn" onclick="closeWalletManager()" style="background: var(--border-color); color: var(--text-color);">
                Tutup
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration (Replace with your config)
        const firebaseConfig = {
            apiKey: "AIzaSyDRqoGxfzUlaiWvKtxhOC9ow1TQMEMPAmg",
              authDomain: "keuangan-6f443.firebaseapp.com",
              projectId: "keuangan-6f443",
              storageBucket: "keuangan-6f443.firebasestorage.app",
              messagingSenderId: "26113576851",
              appId: "1:26113576851:web:fd109685d977b5625e6266",
              measurementId: "G-5PNCPF8TPV"
            };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let isGuestMode = false;
        let currentTab = 0;
        let currentWallet = 'Keuangan';
        let transactions = [];
        let chart = null;
        let touchStartX = 0;
        let touchEndX = 0;

        // Categories with icons and colors
        const categories = {
            income: [
                { name: 'Gaji', icon: 'fas fa-briefcase', color: '#4CAF50' },
                { name: 'Bonus', icon: 'fas fa-gift', color: '#FF9800' },
                { name: 'Investasi', icon: 'fas fa-chart-line', color: '#2196F3' },
                { name: 'Freelance', icon: 'fas fa-laptop', color: '#9C27B0' },
                { name: 'Lainnya', icon: 'fas fa-ellipsis-h', color: '#607D8B' }
            ],
            expense: [
                { name: 'Belanja', icon: 'fas fa-shopping-cart', color: '#f44336' },
                { name: 'Bayar', icon: 'fas fa-credit-card', color: '#FF5722' },
                { name: 'Tabung', icon: 'fas fa-piggy-bank', color: '#795548' },
                { name: 'Transport', icon: 'fas fa-car', color: '#3F51B5' },
                { name: 'Makan', icon: 'fas fa-utensils', color: '#FF9800' },
                { name: 'Lainnya', icon: 'fas fa-ellipsis-h', color: '#607D8B' }
            ]
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupTouchNavigation();
            setupDateInputs();
            loadWallets();
        });

        function initializeApp() {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadUserData();
                } else {
                    showLoginPage();
                }
            });
        }

        // Authentication Functions
        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                console.log('Memulai login...');
                const result = await auth.signInWithPopup(provider);
                console.log('Login berhasil:', result.user);
                currentUser = result.user;
                isGuestMode = false;
                showMainApp();
                loadUserData();
            } catch (error) {
                console.error('Detail error:', error.code, error.message);
                
                // Handle specific errors
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        alert('Login dibatalkan');
                        break;
                    case 'auth/popup-blocked':
                        alert('Popup diblokir browser. Izinkan popup untuk login');
                        break;
                    case 'auth/unauthorized-domain':
                        alert('Domain tidak diotorisasi. Hubungi administrator');
                        break;
                    default:
                        alert('Login gagal: ' + error.message);
                }
            }
        }


        function loginAsGuest() {
            isGuestMode = true;
            currentUser = { uid: 'guest', displayName: 'Tamu', photoURL: null };
            showMainApp();
            loadLocalData();
        }

        function logout() {
            if (!isGuestMode) {
                auth.signOut();
            }
            currentUser = null;
            isGuestMode = false;
            transactions = [];
            showLoginPage();
            closeSettings();
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initializeChart();
            updateDashboard();
        }

        // Navigation Functions
        function switchTab(tabIndex) {
            currentTab = tabIndex;
            const container = document.getElementById('tabContainer');
            container.style.transform = `translateX(-${tabIndex * 33.333}%)`;
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.toggle('active', index === tabIndex);
            });

            // Reset transaction form if switching away from transaction tab
            if (tabIndex !== 1) {
                hideTransactionForm();
            }

            // Load history if switching to history tab
            if (tabIndex === 2) {
                loadTransactionHistory();
            }
        }

        function setupTouchNavigation() {
            const container = document.getElementById('tabContainer');
            
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            container.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0 && currentTab < 2) {
                    // Swipe left (next tab)
                    switchTab(currentTab + 1);
                } else if (diff < 0 && currentTab > 0) {
                    // Swipe right (previous tab)
                    switchTab(currentTab - 1);
                }
            }
        }

        // Settings Functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            const body = document.body;
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                toggle.classList.remove('active');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                toggle.classList.add('active');
                localStorage.setItem('theme', 'dark');
            }
        }

        function showAccountInfo() {
            const name = currentUser.displayName || 'Tamu';
            const email = currentUser.email || 'Mode Tamu';
            alert(`Nama: ${name}\nEmail: ${email}`);
        }

        function showAbout() {
            alert('Aplikasi Monitoring Keuangan\n\nDibuat oleh: Al Fajrin Annas Alamsyah\n\nVersi: 1.0.0');
        }

        // Wallet Management
        function showWalletManager() {
            document.getElementById('walletModal').style.display = 'flex';
            loadWalletList();
            closeSettings();
        }

        function closeWalletManager() {
            document.getElementById('walletModal').style.display = 'none';
        }

        function addWallet() {
            const input = document.getElementById('newWalletInput');
            const walletName = input.value.trim();
            
            if (!walletName) {
                alert('Masukkan nama dompet');
                return;
            }

            const wallets = JSON.parse(localStorage.getItem('wallets') || '["Keuangan"]');
            if (!wallets.includes(walletName)) {
                wallets.push(walletName);
                localStorage.setItem('wallets', JSON.stringify(wallets));
                input.value = '';
                loadWalletList();
            } else {
                alert('Nama dompet sudah ada');
            }
        }

        function loadWallets() {
            const wallets = JSON.parse(localStorage.getItem('wallets') || '["Keuangan"]');
            if (!wallets.includes('Keuangan')) {
                wallets.unshift('Keuangan');
                localStorage.setItem('wallets', JSON.stringify(wallets));
            }
        }

        function loadWalletList() {
            const wallets = JSON.parse(localStorage.getItem('wallets') || '["Keuangan"]');
            const walletList = document.getElementById('walletList');
            
            walletList.innerHTML = wallets.map(wallet => `
                <div class="wallet-item ${wallet === currentWallet ? 'active' : ''}" onclick="switchWallet('${wallet}')">
                    <span>${wallet}</span>
                    <div>
                        ${wallet !== 'Keuangan' ? `<button class="action-btn delete-btn" onclick="deleteWallet('${wallet}', event)">Hapus</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function switchWallet(walletName) {
            currentWallet = walletName;
            document.getElementById('headerTitle').textContent = walletName;
            loadUserData();
            updateDashboard();
            closeWalletManager();
        }

        function deleteWallet(walletName, event) {
            event.stopPropagation();
            if (confirm(`Hapus dompet "${walletName}"?`)) {
                const wallets = JSON.parse(localStorage.getItem('wallets') || '["Keuangan"]');
                const index = wallets.indexOf(walletName);
                if (index > -1) {
                    wallets.splice(index, 1);
                    localStorage.setItem('wallets', JSON.stringify(wallets));
                    
                    // Delete wallet data
                    if (isGuestMode) {
                        localStorage.removeItem(`transactions_guest_${walletName}`);
                    } else {
                        // Delete from Firebase
                        db.collection('transactions')
                            .where('userId', '==', currentUser.uid)
                            .where('wallet', '==', walletName)
                            .get()
                            .then(snapshot => {
                                snapshot.forEach(doc => doc.ref.delete());
                            });
                    }
                    
                    if (currentWallet === walletName) {
                        switchWallet('Keuangan');
                    }
                    loadWalletList();
                }
            }
        }

        // Transaction Functions
        function showTransactionForm(type) {
            document.getElementById('transactionButtons').style.display = 'none';
            document.getElementById('transactionForm').style.display = 'block';
            document.getElementById('formTitle').textContent = type === 'income' ? 'Pemasukan' : 'Pengeluaran';
            
            // Reset form
            document.getElementById('amountInput').value = '';
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('customCategoryInput').classList.add('hidden');
            
            // Load categories
            loadCategories(type);
        }

        function hideTransactionForm() {
            document.getElementById('transactionButtons').style.display = 'flex';
            document.getElementById('transactionForm').style.display = 'none';
        }

        function loadCategories(type) {
            const categoryTags = document.getElementById('categoryTags');
            const cats = categories[type];
            
            categoryTags.innerHTML = cats.map(cat => `
                <div class="category-tag" style="border-color: ${cat.color}" data-category="${cat.name}" onclick="selectCategory('${cat.name}', '${cat.color}', '${cat.icon}')">
                    <i class="${cat.icon}"></i>
                    ${cat.name}
                </div>
            `).join('');
        }

        function selectCategory(name, color, icon) {
            // Remove active from all tags
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            
            // Add active to selected tag
            event.target.classList.add('active');
            event.target.style.backgroundColor = color;
            event.target.style.borderColor = color;
            
            // Show custom input if "Lainnya" selected
            const customInput = document.getElementById('customCategoryInput');
            if (name === 'Lainnya') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = value;
        }

        async function saveTransaction() {
            const amount = document.getElementById('amountInput').value.replace(/\./g, '');
            const date = document.getElementById('dateInput').value;
            const activeTag = document.querySelector('.category-tag.active');
            const customCategory = document.getElementById('customCategoryInput').value.trim();
            
            if (!amount || !date || !activeTag) {
                alert('Lengkapi semua field');
                return;
            }
            
            const category = activeTag.dataset.category === 'Lainnya' && customCategory ? 
                customCategory : activeTag.dataset.category;
            
            const type = document.getElementById('formTitle').textContent === 'Pemasukan' ? 'income' : 'expense';
            
            const transaction = {
                id: Date.now().toString(),
                amount: parseInt(amount),
                date: date,
                category: category,
                type: type,
                wallet: currentWallet,
                createdAt: new Date().toISOString()
            };

            try {
                if (isGuestMode) {
                    saveToLocal(transaction);
                } else {
                    await saveToFirebase(transaction);
                }
                
                transactions.push(transaction);
                updateDashboard();
                hideTransactionForm();
                switchTab(0); // Go back to dashboard
                
                // Show success animation
                showSuccessMessage('Transaksi berhasil disimpan!');
            } catch (error) {
                console.error('Save error:', error);
                alert('Gagal menyimpan transaksi');
            }
        }

        function saveToLocal(transaction) {
            const key = `transactions_guest_${currentWallet}`;
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            existing.push(transaction);
            localStorage.setItem(key, JSON.stringify(existing));
        }

        async function saveToFirebase(transaction) {
            await db.collection('transactions').add({
                ...transaction,
                userId: currentUser.uid
            });
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--success-color);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // Data Loading Functions
        async function loadUserData() {
            if (isGuestMode) {
                loadLocalData();
            } else {
                await loadFirebaseData();
            }
            updateDashboard();
        }

        function loadLocalData() {
            const key = `transactions_guest_${currentWallet}`;
            transactions = JSON.parse(localStorage.getItem(key) || '[]');
        }

        async function loadFirebaseData() {
            try {
                const snapshot = await db.collection('transactions')
                    .where('userId', '==', currentUser.uid)
                    .where('wallet', '==', currentWallet)
                    .orderBy('date', 'desc')
                    .get();
                
                transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Load data error:', error);
                transactions = [];
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            // Update totals
            document.getElementById('totalBalance').textContent = formatRupiah(balance);
            document.getElementById('totalIncome').textContent = formatRupiah(totalIncome);
            document.getElementById('totalExpense').textContent = formatRupiah(totalExpense);
            
            // Update today's transactions
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(t => t.date === today);
            
            const todayIncome = todayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const todayExpense = todayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('todayIncome').textContent = formatRupiah(todayIncome);
            document.getElementById('todayExpense').textContent = formatRupiah(todayExpense);
            
            updateChart();
        }

        function formatRupiah(amount) {
            return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Chart Functions
        function initializeChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pemasukan',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Pengeluaran',
                        data: [],
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!chart) return;
            
            const period = document.querySelector('.chart-btn.active').textContent.toLowerCase();
            let labels = [];
            let incomeData = [];
            let expenseData = [];
            
            if (period === 'minggu') {
                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString('id-ID', { weekday: 'short' }));
                    
                    const dayTransactions = transactions.filter(t => t.date === dateStr);
                    incomeData.push(dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                    expenseData.push(dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
                }
            } else if (period === 'bulan') {
                // Last 30 days grouped by week
                for (let i = 3; i >= 0; i--) {
                    const endDate = new Date();
                    endDate.setDate(endDate.getDate() - (i * 7));
                    const startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 6);
                    
                    labels.push(`Minggu ${4-i}`);
                    
                    const weekTransactions = transactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= startDate && tDate <= endDate;
                    });
                    
                    incomeData.push(weekTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                    expenseData.push(weekTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
                }
            } else {
                // Last 12 months
                for (let i = 11; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    
                    labels.push(date.toLocaleDateString('id-ID', { month: 'short' }));
                    
                    const monthTransactions = transactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate.getMonth() === month && tDate.getFullYear() === year;
                    });
                    
                    incomeData.push(monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                    expenseData.push(monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
                }
            }
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = incomeData;
            chart.data.datasets[1].data = expenseData;
            chart.update();
        }

        function changeChartPeriod(period) {
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            updateChart();
        }

        // History Functions
        function loadTransactionHistory() {
            filterTransactions();
        }

        function filterTransactions() {
            const filter = document.getElementById('filterSelect').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredTransactions = [...transactions];
            
            // Apply date filter
            if (filter !== 'all' && dateFilter) {
                const filterDate = new Date(dateFilter);
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    
                    if (filter === 'date') {
                        return t.date === dateFilter;
                    } else if (filter === 'month') {
                        return tDate.getMonth() === filterDate.getMonth() && 
                               tDate.getFullYear() === filterDate.getFullYear();
                    } else if (filter === 'year') {
                        return tDate.getFullYear() === filterDate.getFullYear();
                    }
                    return true;
                });
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.category.toLowerCase().includes(searchTerm)
                );
            }
            
            displayTransactionHistory(filteredTransactions);
        }

        function searchTransactions() {
            filterTransactions();
        }

        function displayTransactionHistory(transactionList) {
            const container = document.getElementById('transactionList');
            
            if (transactionList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Tidak ada transaksi</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transactionList
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(transaction => {
                    const category = getCategoryInfo(transaction.category, transaction.type);
                    const date = new Date(transaction.date).toLocaleDateString('id-ID');
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon" style="background-color: ${category.color}">
                                    <i class="${category.icon}"></i>
                                </div>
                                <div class="transaction-details">
                                    <h4>${transaction.category}</h4>
                                    <p>${date}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="transaction-amount ${transaction.type === 'income' ? 'income-amount' : 'expense-amount'}">
                                    ${transaction.type === 'income' ? '+' : '-'}${formatRupiah(transaction.amount)}
                                </div>
                                <div class="transaction-actions">
                                    <button class="action-btn edit-btn" onclick="editTransaction('${transaction.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteTransaction('${transaction.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function getCategoryInfo(categoryName, type) {
            const categoryList = categories[type] || categories.expense;
            const category = categoryList.find(cat => cat.name === categoryName) || 
                           categoryList.find(cat => cat.name === 'Lainnya');
            return category;
        }

        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Switch to transaction tab and fill form
            switchTab(1);
            showTransactionForm(transaction.type);
            
            // Fill form with transaction data
            document.getElementById('amountInput').value = transaction.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            document.getElementById('dateInput').value = transaction.date;
            
            // Select category
            setTimeout(() => {
                const categoryTag = document.querySelector(`[data-category="${transaction.category}"]`);
                if (categoryTag) {
                    categoryTag.click();
                } else {
                    // Custom category
                    const lainnyaTag = document.querySelector('[data-category="Lainnya"]');
                    if (lainnyaTag) {
                        lainnyaTag.click();
                        document.getElementById('customCategoryInput').value = transaction.category;
                    }
                }
            }, 100);
            
            // Change save button to update
            const saveBtn = document.querySelector('.save-btn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Transaksi';
            saveBtn.onclick = () => updateTransaction(transactionId);
        }

        async function updateTransaction(transactionId) {
            const amount = document.getElementById('amountInput').value.replace(/\./g, '');
            const date = document.getElementById('dateInput').value;
            const activeTag = document.querySelector('.category-tag.active');
            const customCategory = document.getElementById('customCategoryInput').value.trim();
            
            if (!amount || !date || !activeTag) {
                alert('Lengkapi semua field');
                return;
            }
            
            const category = activeTag.dataset.category === 'Lainnya' && customCategory ? 
                customCategory : activeTag.dataset.category;
            
            const type = document.getElementById('formTitle').textContent === 'Pemasukan' ? 'income' : 'expense';
            
            const updatedTransaction = {
                amount: parseInt(amount),
                date: date,
                category: category,
                type: type,
                updatedAt: new Date().toISOString()
            };

            try {
                // Update in data source
                if (isGuestMode) {
                    updateLocalTransaction(transactionId, updatedTransaction);
                } else {
                    await updateFirebaseTransaction(transactionId, updatedTransaction);
                }
                
                // Update local array
                const index = transactions.findIndex(t => t.id === transactionId);
                if (index > -1) {
                    transactions[index] = { ...transactions[index], ...updatedTransaction };
                }
                
                updateDashboard();
                hideTransactionForm();
                switchTab(0);
                
                // Reset save button
                const saveBtn = document.querySelector('.save-btn');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Transaksi                </button>';
                } catch (error) {
                    console.error('Update error:', error);
                    alert('Gagal memperbarui transaksi');
                }
            }

            function updateLocalTransaction(transactionId, updatedTransaction) {
                const key = `transactions_guest_${currentWallet}`;
                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                const index = existing.findIndex(t => t.id === transactionId);
                if (index > -1) {
                    existing[index] = { ...existing[index], ...updatedTransaction };
                    localStorage.setItem(key, JSON.stringify(existing));
                }
            }

            async function updateFirebaseTransaction(transactionId, updatedTransaction) {
                await db.collection('transactions').doc(transactionId).update(updatedTransaction);
            }

            function deleteTransaction(transactionId) {
                if (confirm('Hapus transaksi ini?')) {
                    if (isGuestMode) {
                        deleteLocalTransaction(transactionId);
                    } else {
                        deleteFirebaseTransaction(transactionId);
                    }
                    transactions = transactions.filter(t => t.id !== transactionId);
                    updateDashboard();
                }
            }

            function deleteLocalTransaction(transactionId) {
                const key = `transactions_guest_${currentWallet}`;
                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                const index = existing.findIndex(t => t.id === transactionId);
                if (index > -1) {
                    existing.splice(index, 1);
                    localStorage.setItem(key, JSON.stringify(existing));
                }
            }

            async function deleteFirebaseTransaction(transactionId) {
                await db.collection('transactions').doc(transactionId).delete();
            }

            // Event Listeners for Modal Close
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('settingsModal')) {
                    closeSettings();
                }
            });

            document.getElementById('walletModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('walletModal')) {
                    closeWalletManager();
                }
            });

            // Initialize Date Inputs
            function setupDateInputs() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dateInput').value = today;
                document.getElementById('dateFilter').value = today;
            }
        </script>
    </body>
</html>
